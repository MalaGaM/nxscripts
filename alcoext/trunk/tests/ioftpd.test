#
# AlcoExt - Alcoholicz Tcl extension.
# Copyright (c) 2005 Alcoholicz Scripting Team
#
# Module Name:
#   ioftpd.test
#
# Author:
#   neoxed (neoxed@gmail.com) Jul 23, 2005
#
# Abstract:
#   ioFTPD interface test suite.
#

package require tcltest 2
namespace import -force ::tcltest::*

if {$tcl_platform(platform) eq "windows"} {
    set libFile "AlcoExt*"
} else {
    set libFile "libAlcoExt*"
}
append libFile [info sharedlibextension]

set currentPath [file dirname [file normalize [info script]]]
set libFile [lindex [glob -dir [file dirname $currentPath] -types f $libFile] 0]
load $libFile

namespace import -force ::alcoholicz::*

# ioFTPD settings (box specific).
set msgWindow "ioFTPD::MessageWindow"

# Check if the message window exists.
if {[catch {ioftpd info $msgWindow io}]} {
    testConstraint msgWndExists 0
} else {
    testConstraint msgWndExists 1
}
unset -nocomplain io

################################################################################
# ioftpd                                                                       #
################################################################################

test ioftpd-1.1 {ioftpd: no args} {win} {
    list [catch {ioftpd} msg] $msg
} {1 {wrong # args: should be "ioftpd option arg ?arg ...?"}}

test ioftpd-1.2 {ioftpd: one arg} {win} {
    list [catch {ioftpd .} msg] $msg
} {1 {bad option ".": must be group, info, kick, kill, user, or who}}

test ioftpd-1.3 {ioftpd: invalid option} {win} {
    list [catch {ioftpd . a} msg] $msg
} {1 {bad option ".": must be group, info, kick, kill, user, or who}}

################################################################################
# ioftpd group                                                                 #
################################################################################

test ioftpd-2.1 {ioftpd group: no args} {win} {
    list [catch {ioftpd group} msg] $msg
} {1 {wrong # args: should be "ioftpd group option arg ?arg ...?"}}

test ioftpd-2.2 {ioftpd group: invalid sub-option} {win} {
    list [catch {ioftpd group . a b} msg] $msg
} {1 {bad option ".": must be exists, get, list, toid, or toname}}

################################################################################
# ioftpd info                                                                  #
################################################################################

test ioftpd-3.1 {ioftpd info: no args} {win} {
    list [catch {ioftpd info} msg] $msg
} {1 {wrong # args: should be "ioftpd info msgWindow varName"}}

test ioftpd-3.2 {ioftpd info: too many args} {win} {
    list [catch {ioftpd info a b c} msg] $msg
} {1 {wrong # args: should be "ioftpd info msgWindow varName"}}

test ioftpd-3.3 {ioftpd info: array elements} {win msgWndExists} {
    ioftpd info $msgWindow io
    set names [lsort [array names io]]
    unset -nocomplain io
    set names
} {path pid time}

test ioftpd-3.4 {ioftpd info: varName isn't an array} {win msgWndExists} {
    unset -nocomplain test; set test 1
    set result [list [catch {ioftpd info $msgWindow test} msg] $msg]
    unset test
    set result
} {1 {can't set "test(path)": variable isn't array}}

################################################################################
# ioftpd kick                                                                  #
################################################################################

test ioftpd-4.1 {ioftpd kick: no args} {win} {
    list [catch {ioftpd kick} msg] $msg
} {1 {wrong # args: should be "ioftpd kick msgWindow uid"}}

test ioftpd-4.2 {ioftpd kick: too many args} {win} {
    list [catch {ioftpd kick a b c} msg] $msg
} {1 {wrong # args: should be "ioftpd kick msgWindow uid"}}

test ioftpd-4.3 {ioftpd kick: invalid int} {win msgWndExists} {
    list [catch {ioftpd kick $msgWindow .} msg] $msg
} {1 {expected integer but got "."}}

test ioftpd-4.4 {ioftpd kick: invalid int} {win msgWndExists} {
    ioftpd kick $msgWindow 0
} {}

################################################################################
# ioftpd kill                                                                  #
################################################################################

test ioftpd-5.1 {ioftpd kill: no args} {win} {
    list [catch {ioftpd kill} msg] $msg
} {1 {wrong # args: should be "ioftpd kill msgWindow cid"}}

test ioftpd-5.2 {ioftpd kill: too many args} {win} {
    list [catch {ioftpd kill a b c} msg] $msg
} {1 {wrong # args: should be "ioftpd kill msgWindow cid"}}

test ioftpd-5.3 {ioftpd kill: invalid int} {win msgWndExists} {
    list [catch {ioftpd kill $msgWindow .} msg] $msg
} {1 {expected integer but got "."}}

test ioftpd-5.4 {ioftpd kill: invalid int} {win msgWndExists} {
    ioftpd kill $msgWindow 0
} {}

################################################################################
# ioftpd user                                                                  #
################################################################################

test ioftpd-6.1 {ioftpd user: no args} {win} {
    list [catch {ioftpd user} msg] $msg
} {1 {wrong # args: should be "ioftpd user option arg ?arg ...?"}}

test ioftpd-6.2 {ioftpd user: invalid sub-option} {win} {
    list [catch {ioftpd user . a b} msg] $msg
} {1 {bad option ".": must be exists, get, list, toid, or toname}}

################################################################################
# ioftpd who                                                                   #
################################################################################

test ioftpd-7.1 {ioftpd who: no args} {win} {
    list [catch {ioftpd who} msg] $msg
} {1 {wrong # args: should be "ioftpd who msgWindow fields"}}

test ioftpd-7.2 {ioftpd who: too many args} {win} {
    list [catch {ioftpd who a b c} msg] $msg
} {1 {wrong # args: should be "ioftpd who msgWindow fields"}}

test ioftpd-7.3 {ioftpd who: invalid field} {win} {
    list [catch {ioftpd who $msgWindow .} msg] $msg
} {1 {bad field ".": must be action, cid, gid, group, host, ident, idletime, ip, logintime, port, realdatapath, realpath, size, speed, status, uid, user, vdatapath, or vpath}}

test ioftpd-7.4 {ioftpd who: check fields} {win msgWndExists} {
    set fields {action cid gid group host ident idletime ip logintime port realdatapath realpath size speed status uid user vdatapath vpath}
    set fieldCount [llength $fields]
    set result ""

    for {set i 0} {$i < $fieldCount} {incr i} {
        set getFields [lrange $fields 0 $i]
        set data [ioftpd who $msgWindow $getFields]
        foreach user $data {
            if {[llength $user] != [llength $getFields]} {
                set result "expected fields \"$getFields\" but got \"$user\""
                break
            }
        }
    }
    unset -nocomplain data user
    set result
} {}


::tcltest::cleanupTests
return
