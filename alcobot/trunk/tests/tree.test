#
# AlcoBot - Alcoholicz site bot.
# Copyright (c) 2005-2006 Alcoholicz Scripting Team
#
# Module Name:
#   Tree Tests
#
# Author:
#   neoxed (neoxed@gmail.com) May 12, 2005
#
# Abstract:
#   Implements regression tests for the tree data store library.
#

package require tcltest 2
namespace import -force ::tcltest::*

################################################################################
# tree::create                                                                 #
################################################################################

test tree-1.1 {tree::create command} {
    tree::create
} {}

test tree-1.2 {tree::create command} {
    tree::create a b
} {a b}

test tree-1.3 {tree::create command} {
    list [catch {tree::create a b c} msg] $msg
} {1 {unbalanced list}}

test tree-1.4 {tree::create command} {
    tree::create c d a b
} {c d a b}

test tree-1.5 {tree::create command} {
    tree::create some [tree::create flag 1] thing [tree::create flag 0] blah [tree::create flag 1]
} {some {flag 1} thing {flag 0} blah {flag 1}}

################################################################################
# tree::exists                                                                 #
################################################################################

test tree-2.1 {tree::exists command} {
    tree::exists {a b} a
} 1

test tree-2.2 {tree::exists command} {
    tree::exists {a b} b
} 0

test tree-2.3 {tree::exists command} {
    tree::exists {a {b c}} a b
} 1

test tree-2.4 {tree::exists command} {
    tree::exists {a {b c}} a c
} 0

test tree-2.5 {tree::exists command} {
    tree::exists {a {b c}} b c
} 0

test tree-2.6 {tree::exists command} {
    list [catch {tree::exists} msg] $msg
} {1 {wrong # args: should be "tree::exists tree key args"}}

test tree-2.7 {tree::exists command} {
    list [catch {tree::exists {}} msg] $msg
} {1 {wrong # args: should be "tree::exists tree key args"}}

################################################################################
# tree::get                                                                    #
################################################################################

test tree-3.1 {tree::get command} {
    tree::get {a b} a
} {b}

test tree-3.2 {tree::get command} {
    tree::get {a b c d} a
} {b}

test tree-3.3 {tree::get command} {
    tree::get {a b c d} c
} {d}

test tree-3.4 {tree::get command} {
    list [catch {tree::get {a b c d} b} msg] $msg
} {1 {key "b" not known in tree}}

test tree-3.5 {tree::get command} {
    tree::get {a {p q r s} b {u v x y}} a p
} {q}

test tree-3.6 {tree::get command} {
    tree::get {a {p q r s} b {u v x y}} a r
} {s}

test tree-3.7 {tree::get command} {
    tree::get {a {p q r s} b {u v x y}} b u
} {v}

test tree-3.8 {tree::get command} {
    tree::get {a {p q r s} b {u v x y}} b x
} {y}

test tree-3.9 {tree::get command} {
    list [catch {tree::get {a {p q r s} b {u v x y}} a z} msg] $msg
} {1 {key "z" not known in tree}}

test tree-3.10 {tree::get command} {
    list [catch {tree::get {a {p q r s} b {u v x y}} c z} msg] $msg
} {1 {key "c" not known in tree}}

test tree-3.11 {tree::get command} {
    tree::get [tree::create a b c d] a
} {b}

test tree-3.12 {tree::get command} {
    list [catch {tree::get} msg] $msg
} {1 {wrong # args: should be "tree::get tree key args"}}

################################################################################
# tree::get2                                                                   #
################################################################################

test tree-3.1 {tree::get2 command} {
    tree::get2 {a b} a
} {b}

test tree-3.2 {tree::get2 command} {
    tree::get2 {a b c d} a
} {b}

test tree-3.3 {tree::get2 command} {
    tree::get2 {a b c d} c
} {d}

test tree-3.4 {tree::get2 command} {
    list [catch {tree::get2 {a b c d} b} msg] $msg
} {0 {}}

test tree-3.5 {tree::get2 command} {
    tree::get2 {a {p q r s} b {u v x y}} a p
} {q}

test tree-3.6 {tree::get2 command} {
    tree::get2 {a {p q r s} b {u v x y}} a r
} {s}

test tree-3.7 {tree::get2 command} {
    tree::get2 {a {p q r s} b {u v x y}} b u
} {v}

test tree-3.8 {tree::get2 command} {
    tree::get2 {a {p q r s} b {u v x y}} b x
} {y}

test tree-3.9 {tree::get2 command} {
    list [catch {tree::get2 {a {p q r s} b {u v x y}} a z} msg] $msg
} {0 {}}

test tree-3.10 {tree::get2 command} {
    list [catch {tree::get2 {a {p q r s} b {u v x y}} c z} msg] $msg
} {0 {}}

test tree-3.11 {tree::get2 command} {
    tree::get2 [tree::create a b c d] a
} {b}

test tree-3.12 {tree::get2 command} {
    list [catch {tree::get2} msg] $msg
} {1 {wrong # args: should be "tree::get2 tree key args"}}

################################################################################
# tree::keys                                                                   #
################################################################################

test tree-4.1 {tree::keys command} {
    tree::keys {a b}
} {a}

test tree-4.2 {tree::keys command} {
    tree::keys {c d}
} {c}

test tree-4.3 {tree::keys command} {
    lsort [tree::keys {a b c d}]
} {a c}

test tree-4.4 {tree::keys command} {
    tree::keys {a b c d} a
} {a}

test tree-4.5 {tree::keys command} {
    tree::keys {a b c d} c
} {c}

test tree-4.6 {tree::keys command} {
    tree::keys {a b c d} e
} {}

test tree-4.7 {tree::keys command} {
    lsort [tree::keys {a b c d ca da} c*]
} {c ca}

test tree-4.8 {tree::keys command} {
    list [catch {tree::keys} msg] $msg
} {1 {wrong # args: should be "tree::keys tree ?pattern?"}}

test tree-4.9 {tree::keys command} {
    list [catch {tree::keys {} a b} msg] $msg
} {1 {wrong # args: should be "tree::keys tree ?pattern?"}}

################################################################################
# tree::values                                                                 #
################################################################################

test tree-5.1 {tree::values command} {
    tree::values {a b}
} {b}

test tree-5.2 {tree::values command} {
    tree::values {c d}
} {d}

test tree-5.3 {tree::values command} {
    lsort [tree::values {a b c d}]
} {b d}

test tree-5.4 {tree::values command} {
    tree::values {a b c d} b
} {b}

test tree-5.5 {tree::values command} {
    tree::values {a b c d} d
} {d}

test tree-5.6 {tree::values command} {
    tree::values {a b c d} e
} {}

test tree-5.7 {tree::values command} {
    lsort [tree::values {a b c d ca da} d*]
} {d da}

test tree-5.8 {tree::values command} {
    list [catch {tree::values} msg] $msg
} {1 {wrong # args: should be "tree::values tree ?pattern?"}}

test tree-5.9 {tree::values command} {
    list [catch {tree::values {} a b} msg] $msg
} {1 {wrong # args: should be "tree::values tree ?pattern?"}}

################################################################################
# tree::for                                                                    #
################################################################################

test tree-6.1 {tree::for command: syntax} {
    list [catch {tree::for} msg] $msg
} {1 {wrong # args: should be "tree::for vars tree body"}}

test tree-6.2 {tree::for command: syntax} {
    list [catch {tree::for x} msg] $msg
} {1 {wrong # args: should be "tree::for vars tree body"}}

test tree-6.3 {tree::for command: syntax} {
    list [catch {tree::for x x} msg] $msg
} {1 {wrong # args: should be "tree::for vars tree body"}}

test tree-6.4 {tree::for command: syntax} {
    list [catch {tree::for x x x x} msg] $msg
} {1 {wrong # args: should be "tree::for vars tree body"}}

test tree-6.5 {tree::for command: syntax} {
    list [catch {tree::for x x x} msg] $msg
} {1 {must have exactly two variable names}}

test tree-6.6 {tree::for command: syntax} {
    list [catch {tree::for {x x x} x x} msg] $msg
} {1 {must have exactly two variable names}}

test tree-6.7 {tree::for command: syntax} {
    list [catch {tree::for "\{x" x x} msg] $msg
} {1 {unmatched open brace in list}}

test tree-6.8 {tree::for command} {
    # This test confirms that [tree::keys], [tree::values] and [tree::for]
    # all traverse a tree in the same order.
    set treev {a A b B c C}
    set keys {}
    set values {}
    tree::for {k v} $treev {
	    lappend keys $k
	    lappend values $v
    }
    set result [expr {$keys eq [tree::keys $treev] && $values eq [tree::values $treev]}]
    expr {$result ? "YES" : [list "NO" $treev $keys $values]}
} {YES}

test tree-6.9 {tree::for command} {
    tree::for {k v} {} {
	    error "unexpected execution of 'tree::for' body"
    }
} {}

test tree-6.10 {tree::for command: script results} {
    set times 0
    tree::for {k v} {a a b b} {
    	incr times
    	continue
    	error "shouldn't get here"
    }
    set times
} {2}

test tree-6.11 {tree::for command: script results} {
    set times 0
    tree::for {k v} {a a b b} {
    	incr times
    	break
    	error "shouldn't get here"
    }
    set times
} 1

test tree-6.12 {tree::for command: handle representation loss} {
    set treeVar {a b c d e f g h}
    set keys {}
    set values {}
    tree::for {k v} $treeVar {
    	if {[llength $treeVar]} {
    	    lappend keys $k
    	    lappend values $v
    	}
    }
    list [lsort $keys] [lsort $values]
} {{a c e g} {b d f h}}

test tree-6.13 {tree::for command: keys are unique and iterated over once only} {
    set treeVar {a1 a a2 b b1 c b2 d foo bar bar foo}
    catch {unset accum}
    array set accum {}
    tree::for {k v} $treeVar {
	    append accum($k) $v,
    }
    set result [lsort [array names accum]]
    lappend result :
    foreach k $result {
	    catch {lappend result $accum($k)}
    }
    catch {unset accum}
    set result
} {a1 a2 b1 b2 bar foo : a, b, c, d, foo, bar,}

################################################################################
# tree::set                                                                    #
################################################################################

test tree-7.1 {tree::set command} {
    set treeVar {}
    tree::set treeVar a x
} {a x}

test tree-7.2 {tree::set command} {
    set treeVar {a {}}
    tree::set treeVar a b x
} {a {b x}}

test tree-7.3 {tree::set command} {
    set treeVar {a {b {}}}
    tree::set treeVar a b c x
} {a {b {c x}}}

test tree-7.4 {tree::set command} {
    set treeVar {a y}
    tree::set treeVar a x
} {a x}

test tree-7.5 {tree::set command} {
    set treeVar {a {b y}}
    tree::set treeVar a b x
} {a {b x}}

test tree-7.6 {tree::set command} {
    set treeVar {a {b {c y}}}
    tree::set treeVar a b c x
} {a {b {c x}}}

test tree-7.7 {tree::set command: path creation} {
    set treeVar {}
    tree::set treeVar a b x
} {a {b x}}

test tree-7.8 {tree::set command: creates variables} {
    catch {unset treeVar}
    tree::set treeVar a x
    set treeVar
} {a x}

test tree-7.9 {tree::set command: write failure} {
    catch {unset treeVar}
    set treeVar(block) {}
    set result [list [catch {tree::set treeVar a x} msg] $msg]
    catch {unset treeVar}
    set result
} {1 {can't read "tree": variable is array}}

test tree-7.10 {tree::set command: syntax} {
    list [catch {tree::set} msg] $msg
} {1 {wrong # args: should be "tree::set treeVar key value args"}}

test tree-7.11 {tree::set command: syntax} {
    list [catch {tree::set a} msg] $msg
} {1 {wrong # args: should be "tree::set treeVar key value args"}}

test tree-7.12 {tree::set command: syntax} {
    list [catch {tree::set a a} msg] $msg
} {1 {wrong # args: should be "tree::set treeVar key value args"}}

################################################################################
# tree::unset                                                                  #
################################################################################

test tree-8.1 {tree::unset command} {
    set treeVar {a b c d}
    tree::unset treeVar a
} {c d}

test tree-8.2 {tree::unset command} {
    set treeVar {a b c d}
    tree::unset treeVar c
} {a b}

test tree-8.3 {tree::unset command} {
    set treeVar {a b}
    tree::unset treeVar c
} {a b}

test tree-8.4 {tree::unset command} {
    set treeVar {a {b c d e}}
    tree::unset treeVar a b
} {a {d e}}

test tree-8.5 {tree::unset command} {
    set treeVar {a b}
    list [catch {tree::unset treeVar c d} msg] $msg
} {0 {a b}}

test tree-8.6 {tree::unset command} {
    catch {unset treeVar}
    list [info exists treeVar] [tree::unset treeVar a] [info exists treeVar]
} {0 {} 0}

test tree-8.7 {tree::unset command} {
    list [catch {tree::unset treeVar} msg] $msg
} {1 {wrong # args: should be "tree::unset treeVar key args"}}

test tree-8.8 {tree::unset command: write failure} {
    catch {unset treeVar}
    set treeVar(block) {}
    set result [list [catch {tree::unset treeVar a} msg] $msg]
    catch {unset treeVar}
    set result
} {1 {can't read "tree": variable is array}}


::tcltest::cleanupTests
return
